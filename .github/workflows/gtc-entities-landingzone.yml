on:
  push:
    branches:
    - main  
  pull_request:
    branches:
    - main    

env:
  APPINSIGHTS_NAME: 'appi-entities-dev-001'
  ARM_PATH: './.azure'
  AZURE_RG_NAME: 'gtc-rg-entities-dev-001'
  AZURE_RG_LOCATION: 'westus3'
  KEYVAULT_NAME: 'kv-entities-dev-001'
  PLAN_CAPACITY: 4
  PLAN_NAME: 'plan-entities-dev-001'
  PLAN_SKU: 'F1'
  STORAGE_NAME: 'stentitiesdev001'
  WORKSPACE_NAME: 'work-entities-dev-001'

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:  
  development_Stage_deploy_landing_zone:
    name: 'Deploy landing zone IaC'
    runs-on: ubuntu-latest
    env:
      template: ../variables/development.yml
    if: (github.ref != 'refs/heads/main')
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: 'Az CLI login'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy ${{ env.AZURE_RG_NAME }}
        uses: Azure/cli@v1.0.0
        with:
          inlineScript: az group create -n ${{ env.AZURE_RG_NAME }} -l ${{ env.AZURE_RG_LOCATION }}
      # stPRODUCTENVIRONMENT001
      - name: Run ARM deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RG_NAME }}
          template: ${{ env.ARM_PATH }}/st-storageaccount.json
          parameters: name=${{ env.STORAGE_NAME }}
      # kv-PRODUCT-ENVIRONMENT-001
      - name: Run ARM deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RG_NAME }}
          template: ${{ env.ARM_PATH }}/kv-keyvault.json
          parameters: name=${{ env.KEYVAULT_NAME }}
      # work-PRODUCT-ENVIRONMENT-001
      - name: Run ARM deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RG_NAME }}
          template: ${{ env.ARM_PATH }}/work-loganalyticsworkspace.json
          parameters: name=${{ env.WORKSPACE_NAME }}
      # appi-PRODUCT-ENVIRONMENT-001
      - name: Run ARM deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RG_NAME }}
          template: ${{ env.ARM_PATH }}/st-storageaccount.json
          parameters: name=${{ env.APPINSIGHTS_NAME }} workName=${{ env.WORKSPACE_NAME }}
      # plan-PRODUCT-ENVIRONMENT-001
      - name: Run ARM deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RG_NAME }}
          template: ${{ env.ARM_PATH }}/st-storageaccount.json
          parameters: name=${{ env.PLAN_NAME }} sku=${{ env.PLAN_SKU }} skuCapacity=${{ env.PLAN_CAPACITY }}